<div class="doctor-dashboard">
    <h1 class="header">👨‍⚕️ Doctor Dashboard</h1>
    <p class="subtext">Welcome, Doctor</p>

    <div class="status-box">
        <strong>Status:</strong> {{ apiMessage }}
    </div>

    <hr>

    <h2>📩 Patient Messages</h2>

    <!-- ✅ Show loader while fetching -->
    <div *ngIf="isLoading">
        <p>Loading patient messages...</p>
    </div>

    <!-- ✅ Show messages once loaded -->
    <div *ngIf="!isLoading && messages && messages.length > 0">
        <div *ngFor="let msg of messages" class="message-card" [ngClass]="{'severity-high': msg.severity === 'HIGH'}">
            <div class="message-header">
                <strong>From:</strong> {{ msg.sender?.username }}
                <span class="severity-tag"
                      [ngClass]="{'high': msg.severity === 'HIGH', 'medium': msg.severity === 'MEDIUM', 'low': msg.severity === 'LOW'}">
                    {{ msg.severity || 'LOW' }}
                </span>
            </div>

            <div class="message-body">
                <p><strong>Message:</strong> {{ msg.content }}</p>
                <p><strong>Time:</strong> {{ msg.timestamp | date:'medium' }}</p>
            </div>

            <!-- Respond form (extended with dosageTiming & durationDays) -->
            <form #prescriptionForm="ngForm" (ngSubmit)="respondToPatient(msg.id, prescriptionForm)"
                class="prescription-form">
                <input type="text" name="diagnosis" ngModel required placeholder="Enter diagnosis"
                    class="input-field" />

                <input type="text" name="medication" ngModel required placeholder="Enter medication"
                    class="input-field" />

                <!-- Dosage timing (optional but included in payload) -->
                <div class="form-row">
                    <label for="dosageTiming-{{msg.id}}">Dosage timing</label>
                    <select id="dosageTiming-{{msg.id}}" name="dosageTiming" ngModel class="input-field">
                        <option value="">-- select timing (optional) --</option>
                        <option value="Morning">Morning</option>
                        <option value="Afternoon">Afternoon</option>
                        <option value="Evening">Evening</option>
                        <option value="Night">Night</option>
                        <option value="Morning, Night">Morning & Night</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Duration days (optional) -->
                <div class="form-row">
                    <label for="durationDays-{{msg.id}}">Duration (days)</label>
                    <input id="durationDays-{{msg.id}}" name="durationDays" type="number" min="0" ngModel
                        placeholder="e.g. 5" class="input-field" />
                </div>

                <button type="submit" [disabled]="prescriptionForm.invalid" class="respond-btn">
                    💊 Send Prescription
                </button>
            </form>
        </div>
    </div>

    <!-- ✅ Show fallback when loaded but empty -->
    <div *ngIf="!isLoading && (!messages || messages.length === 0)">
        <p>No messages assigned to you yet 🕊️</p>
    </div>

    <hr>

    <button class="logout-btn" (click)="logout()">🚪 Logout</button>
</div>